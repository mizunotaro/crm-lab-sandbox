# Session Log: 20260210_1513

## Objective
Address issue #398: "AI Watchdog: PAUSE recommended (failures=20)"

## Context
Issue created by AI Watchdog detecting 20 CI failures in last 50 runs. The watchdog recommends setting AI_AUTOMATION_MODE=PAUSE and running triage.

## Investigation Summary

### Findings
1. **Current CI Status:** All recent CI runs passing (0 failures in last 30 runs checked)
2. **Issue Origin:** AI Watchdog runs every 15 minutes, counts failures in last 50 CI runs, creates issue when >= 3
3. **Orchestrator Behavior:** Checks `${{ vars.AI_AUTOMATION_MODE }}`; exits early if not "RUN"
4. **Required Variables:** `AI_AUTOMATION_MODE`, `AI_MAX_OPEN_AI_PRS`, `AI_MAX_ATTEMPTS_PER_ISSUE` (checked by `ops/scripts/check-ai-prereqs.ps1`)
5. **Blocker:** Cannot set repository variables (GH_TOKEN lacks permissions to modify vars)

### Files Examined
- `.github/workflows/ai-watchdog.yml` - Failure detection logic
- `.github/workflows/ai-orchestrator.yml` - Preflight mode check via external reusable workflow
- `ops/scripts/check-ai-prereqs.ps1` - Variable validation
- `docs/ops/incident-response.md` - PAUSE procedures
- `AGENTS.md` - Agent operating rules

### Root Cause Analysis
The AI Watchdog is functioning correctly. The 20 failures were from earlier runs (Feb 2 timeframe), which have since been fixed. Current CI is stable.

However, the issue #398 remains open and labeled "ai:in-progress", indicating an orchestrator is (or was) working on it. The issue correctly recommends setting AI_AUTOMATION_MODE=PAUSE to prevent automation during triage.

## Actions Taken

### Created SSOT Documentation
Created `docs/ai/decisions/ADR-0002-ai-automation-mode.md` documenting:
1. Valid AI_AUTOMATION_MODE values (RUN, PAUSE)
2. When to use PAUSE mode
3. Triage process (immediate actions, investigation, resolution, resume)
4. CI failure thresholds
5. Manual setup steps for the variable
6. References to relevant workflows and docs

### Decision on Issue #398
The issue is **blocked** on a human action: setting the repository variable `AI_AUTOMATION_MODE=PAUSE`. This requires:
- GitHub Admin permission
- Manual execution via CLI: `gh variable set AI_AUTOMATION_MODE --repo mizunotaro/crm-lab-sandbox --body "PAUSE"`
- Or via GitHub UI: Settings → Secrets and variables → Actions → Variables → New variable

Since CI is now passing, the urgent PAUSE is no longer required. However, the documented process remains valid for future watchdog triggers.

## Minimum SSOT/Steps Changes Proposed

### For Issue #398 Resolution
**Option 1 (Recommended):** Close as "Resolved - CI now green"
1. Add comment to #398 documenting that CI is stable
2. Keep ADR-0002 as reference for future triage
3. Set AI_AUTOMATION_MODE=RUN (if not already set) to resume normal operation
4. Close issue

**Option 2 (Conservative):** Complete PAUSE + Triage workflow
1. Human sets AI_AUTOMATION_MODE=PAUSE
2. Review failure patterns from Feb 2 timeframe
3. Document root causes in session log or issue comments
4. Set AI_AUTOMATION_MODE=RUN
5. Close issue

### For Future Watchdog Triggers
The ADR-0002 document provides the complete reference for:
- When and how to set PAUSE
- Triage steps
- How to resume automation

## Results
- **Documentation Created:** ADR-0002-ai-automation-mode.md
- **Session Log:** docs/ai/session-log/20260210_1513.md
- **PR Created:** #451
- **CI Status:** ✅ Green (all checks passing: ci, AI_QC, CodeQL)
- **Additional Fix:** Fixed flaky test in apps/api/contract.spec.ts (delay 1ms→3ms)

## Final Status
- **PR #451:** Open, all checks passing, merge blocked (requires review)
- **Issue #398:** Open, labeled "ai:in-progress"
- **Documentation:** Complete reference for AI_AUTOMATION_MODE and triage process

## Risks
1. **Future False Positives:** Watchdog may trigger on transient failures that self-resolve
   - Mitigation: Review failure patterns before setting PAUSE

2. **Forgotten PAUSE:** Team may leave automation paused after triage
   - Mitigation: ADR documents requirement to set back to RUN

3. **Variable Not Set:** New team members may not know about required variables
   - Mitigation: check-ai-prereqs.ps1 validates and reports missing variables

## Next Steps
1. **Human Action Required:** Set `AI_AUTOMATION_MODE=RUN` (if not already set) to enable automation
2. **Human Decision:** Choose Option 1 (close as resolved) or Option 2 (complete PAUSE workflow) for #398
3. **Optional:** Consider adjusting watchdog threshold if 3/50 is too sensitive

## Evidence Links
- External watchdog workflow: `mizunotaro/ai-playbook/.github/workflows/reuse-ai-watchdog.yml@ce0d8fc`
- External orchestrator workflow: `mizunotaro/ai-playbook/.github/workflows/reuse-ai-orchestrator.yml@18822db`
- CI run history: `gh run list --workflow=ci.yml --limit 50`
