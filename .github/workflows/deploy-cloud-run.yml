---
name: Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      region:
        description: 'GCP region'
        required: true
        default: 'us-central1'
        type: string
      service_name:
        description: 'Cloud Run service name'
        required: true
        default: 'crm-api'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm --filter @crm/api test:run

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Configure Docker to use gcloud as a credential helper
        run: |
          gcloud auth configure-docker ${{ inputs.region }}-docker.pkg.dev

      - name: Build and push Docker image
        run: |
          # TODO: Implement build logic based on your app structure
          # This is a placeholder - adjust paths and build commands
          # Example:
          # IMAGE_TAG="latest"
          # REPO="${{ secrets.GCP_ARTIFACT_REGISTRY_REPO }}"
          # PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          # REGISTRY="${{ inputs.region }}-docker.pkg.dev"
          # BASE="${REGISTRY}/${PROJECT}/${REPO}"
          # IMAGE_URL="${BASE}/${{ inputs.service_name }}:${IMAGE_TAG}"
          #
          # docker build -t ${IMAGE_URL} -f apps/api/Dockerfile .
          # docker push ${IMAGE_URL}
          #
          # echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT

          echo "TODO: Implement Docker build and push logic"
          exit 1

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          # TODO: Implement Cloud Run deployment
          # This is a placeholder - adjust based on your requirements
          # Example:
          # gcloud run deploy ${{ inputs.service_name }} \
          #   --image ${{ steps.build.outputs.image_url }} \
          #   --platform managed \
          #   --region ${{ inputs.region }} \
          #   --allow-unauthenticated \
          #   --set-env-vars "NODE_ENV=${{ inputs.environment }}" \
          #   --set-env-secrets "DATABASE_URL=${{ secrets.CLOUD_RUN_DB_URL }}" \
          #   --project ${{ secrets.GCP_PROJECT_ID }}

          echo "TODO: Implement Cloud Run deployment"
          exit 1

      - name: Verify deployment
        run: |
          # TODO: Add health check verification
          # Example:
          # SVC_NAME="${{ inputs.service_name }}"
          # SERVICE_URL=$(gcloud run services describe ${SVC_NAME} \
          #   --platform managed \
          #   --region ${{ inputs.region }} \
          #   --format="value(status.url)" \
          #   --project ${{ secrets.GCP_PROJECT_ID }})
          #
          # echo "Service URL: ${SERVICE_URL}"
          # curl -f ${SERVICE_URL}/health || exit 1

          echo "TODO: Implement deployment verification"

