name: AI Orchestrator

on:
  schedule:
    - cron: "*/15 * * * *" # JP: 15分おき / EN: every 15 min
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: ai-orchestrator-${{ github.repository }}
  cancel-in-progress: false

jobs:
  check_pause:
    runs-on: ubuntu-latest
    outputs:
      paused: ${{ steps.check_mode.outputs.paused }}
      pause_reason: ${{ steps.check_mode.outputs.reason }}
    steps:
      - name: Check AI_AUTOMATION_MODE
        id: check_mode
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mode="${{ vars.AI_AUTOMATION_MODE }}"
          echo "AI_AUTOMATION_MODE=${mode:-not set}"
          
          if [ "$mode" = "PAUSE" ]; then
            echo "paused=true" >> $GITHUB_OUTPUT
            echo "reason=AI_AUTOMATION_MODE=PAUSE" >> $GITHUB_OUTPUT
            echo "::warning::AI automation paused (AI_AUTOMATION_MODE=PAUSE)"
            exit 0
          fi

          # Check if issue #397 (AI Watchdog pause recommendation) is open
          issue_state=$(gh issue view 397 --repo "${{ github.repository }}" --json state --jq '.state' 2>/dev/null || echo "not_found")
          if [ "$issue_state" = "OPEN" ]; then
            has_pause_label=$(gh issue view 397 --repo "${{ github.repository }}" --json labels --jq '.labels[].name' | grep -c "ai:pause" || true)
            if [ "$has_pause_label" -gt 0 ]; then
              echo "paused=true" >> $GITHUB_OUTPUT
              echo "reason=Issue #397 with ai:pause label" >> $GITHUB_OUTPUT
              echo "::warning::AI automation paused (Issue #397 with ai:pause label)"
              exit 0
            fi
          fi
          
          echo "paused=false" >> $GITHUB_OUTPUT
          echo "AI automation will proceed"

  preflight:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # NOTE: Do NOT use microsoft/setup-powershell here.
      # GitHub-hosted runners already include pwsh; we verify it exists (fail-fast).
      - name: Verify pwsh is available (fail-fast)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "ERROR: pwsh not found on runner. This workflow expects runner-provided PowerShell."
            exit 1
          fi
          echo "OK: pwsh found at: $(command -v pwsh)"
          pwsh -NoProfile -Command '$PSVersionTable.PSVersion.ToString()'

      - name: Parser check (fail-fast) for check-ai-prereqs.ps1
        shell: pwsh
        run: |
          $path = "ops/scripts/check-ai-prereqs.ps1"
          if (-not (Test-Path -LiteralPath $path)) {
            Write-Error "Missing script: $path"
            exit 1
          }
          $tokens=$null; $errors=$null
          [void][System.Management.Automation.Language.Parser]::ParseFile((Resolve-Path $path), [ref]$tokens, [ref]$errors)
          if (@($errors).Count -gt 0) {
            $errors | Format-List *
            throw "ParserError detected in $path"
          }
          Write-Host "OK: Parser check passed for $path"

      - name: Run AI prerequisites check
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./ops/scripts/check-ai-prereqs.ps1 -Repo "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ github.token }}

      # Always emit the ai-prereqs JSON so failures are diagnosable without reruns.
      - name: Dump ai-prereqs JSON (always)
        if: always()
        shell: pwsh
        run: |
          $dir = "ops/logs"
          if (-not (Test-Path -LiteralPath $dir)) {
            Write-Host "No ops/logs directory found."
            exit 0
          }
          $p = Get-ChildItem -Path $dir -Filter 'ai-prereqs-*.json' -File -ErrorAction SilentlyContinue |
            Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $p) {
            Write-Host "No ai-prereqs JSON found under $dir."
            exit 0
          }
          Write-Host "ai-prereqs log: $($p.FullName)"
          Get-Content -LiteralPath $p.FullName -Raw

  call:
    needs: [check_pause, preflight]
    if: needs.check_pause.outputs.paused == 'false'
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    uses: mizunotaro/ai-playbook/.github/workflows/reuse-ai-orchestrator.yml@18822dbf6a08d9f579d344a8cac974e047842ffc
    with:
      # Align to your OpenCode GitHub install selection:
      # Provider: Z.AI Coding Plan, Model: GLM-4.7
      model: "zai-coding-plan/glm-4.7"
    secrets:
      # Either name works; reusable workflow normalizes it.
      ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
      ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
