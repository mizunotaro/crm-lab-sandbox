name: AI Orchestrator

on:
  schedule:
    - cron: "*/15 * * * *" # JP: 15分おき / EN: every 15 min
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: ai-orchestrator-${{ github.repository }}
  cancel-in-progress: false

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify pwsh is available (fail-fast)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo "::error::pwsh not found on runner (ubuntu-latest)."
            echo "::error::This workflow requires pwsh preinstalled (or change runner / add explicit install in a separately approved change)."
            exit 1
          fi
          pwsh -NoProfile -Command '$PSVersionTable.PSVersion'

      - name: Run AI prerequisites check
        shell: pwsh
        run: |
          ./ops/scripts/check-ai-prereqs.ps1 -Repo '${{ github.repository }}'
        env:
          GH_TOKEN: ${{ github.token }}

  call:
    needs: preflight
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    uses: mizunotaro/ai-playbook/.github/workflows/reuse-ai-orchestrator.yml@18822dbf6a08d9f579d344a8cac974e047842ffc
    with:
      # Align to your OpenCode GitHub install selection:
      # Provider: Z.AI Coding Plan, Model: GLM-4.7
      model: "zai-coding-plan/glm-4.7"
    secrets:
      # Either name works; reusable workflow normalizes it.
      ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
      ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
