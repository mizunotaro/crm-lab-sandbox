name: ci-postmortem

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]

permissions:
  :contentReference[oaicite:5]{index=5}e
  pull-requests: write
  issues: write

jobs:
  postmortem:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Collect failure details
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get jobs + step conclusions
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner, repo, run_id: run.id, per_page: 100
            });

            const failed = [];
            for (const j of jobs.data.jobs) {
              if (j.conclusion && j.conclusion !== 'success') {
                const stepSummary = (j.steps || [])
                  .filter(s => s.conclusion && s.conclusion !== 'success')
                  .map(s => `- ${s.name}: ${s.conclusion}`)
                  .join('\n');
                failed.push({ job: j.name, conclusion: j.conclusion, steps: stepSummary || '(no failing steps info)' });
              }
            }

            core.setOutput("run_id", String(run.id));
            core.setOutput("run_url", run.html_url);
            core.setOutput("head_sha", run.head_sha);
            core.setOutput("head_branch", run.head_branch);
            core.setOutput("workflow_name", run.name);
            core.setOutput("conclusion", run.conclusion);
            core.setOutput("failed_json", JSON.stringify(failed, null, 2));

      - name: Write incident memo
        shell: bash
        run: |
          RUN_ID="${{ steps.collect.outputs.run_id }}"
          TS="$(date -u +%Y%m%d_%H%M)"
          FILE="docs/ai/incidents/CI_FAIL_${TS}_run${RUN_ID}.md"

          mkdir -p docs/ai/incidents

          cat > "$FILE" << 'EOF'
          # CI Postmortem (Auto)

          - Workflow: ${{ steps.collect.outputs.workflow_name }}
          - Conclusion: ${{ steps.collect.outputs.conclusion }}
          - Run: ${{ steps.collect.outputs.run_url }}
          - Branch: ${{ steps.collect.outputs.head_branch }}
          - Commit: ${{ steps.collect.outputs.head_sha }}

          ## Failed jobs/steps (best-effort)
          EOF

          echo '${{ steps.collect.outputs.failed_json }}' >> "$FILE"

          echo "" >> docs/ai/lessons-learned.md
          echo "- CI failure observed: ${{ steps.collect.outputs.workflow_name }} (${{ steps.collect.outputs.conclusion }}) run=${{ steps.collect.outputs.run_url }}" >> docs/ai/lessons-learned.md

      - name: Create PR with memo
        uses: peter-evans/create-pull-request@v8
        with:
          branch: chore/ci-postmortem
          title: "chore: add CI postmortem memo"
          body: |
            Auto-generated CI postmortem memo for a failed run.
            Run: ${{ steps.collect.outputs.run_url }}
          commit-message: "chore: add CI postmortem memo"
          add-paths: |
            docs/ai/incidents/*
            docs/ai/lessons-learned.md
