name: AI Prerequisites Preflight Check

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    paths:
      - '.github/workflows/**'
      - 'ops/scripts/**'

permissions:
  contents: read
  issues: write
  statuses: write

jobs:
  preflight-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PowerShell
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            echo 'ERROR: pwsh not found on runner. Remove this check only if your job does not need pwsh.' >&2
            exit 1
          fi
          pwsh -v

      - name: Run AI prerequisites check
        id: prereqs
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./ops/scripts/check-ai-prereqs.ps1 -Repo ${{ github.repository }} -JsonOnly -LogDir ./ops/logs
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Parse results
        if: always() && steps.prereqs.outcome != 'skipped'
        id: parse
        run: |
          # Get the log file path (preferred: output from the pwsh step; fallback: search known directories)
          LOG_FILE="${{ steps.prereqs.outputs.log_file }}"
          if [ -z "$LOG_FILE" ] || [ ! -f "$LOG_FILE" ]; then
            LOG_FILE="$(ls -t ./ops/logs/ai-prereqs-*.json ./ops/scripts/ai-prereqs-*.json 2>/dev/null | head -1 || true)"
          fi
          if [ -z "$LOG_FILE" ] || [ ! -f "$LOG_FILE" ]; then
            echo "ERROR: ai-prereqs JSON log not found (expected in ./ops/logs or ./ops/scripts, or via steps.prereqs.outputs.log_file)." >&2
            echo "::group::debug: ls -la ./ops/logs" && ls -la ./ops/logs 2>/dev/null || true && echo "::endgroup::"
            echo "::group::debug: ls -la ./ops/scripts" && ls -la ./ops/scripts 2>/dev/null || true && echo "::endgroup::"
            exit 2
          fi
          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT

          if ! command -v jq >/dev/null 2>&1; then
            echo "ERROR: jq not found on runner." >&2
            exit 1
          fi

          # Parse JSON
          STATUS=$(jq -r '.status' "$LOG_FILE")
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          if [ "$STATUS" != "pass" ]; then
            SUMMARY=$(jq -r '.summary' "$LOG_FILE")
            echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

            # Count missing items
            MISSING_LABELS=$(jq -r '.checks.labels.missing | length' "$LOG_FILE")
            MISSING_SECRETS=$(jq -r '.checks.secrets.missing | length' "$LOG_FILE")
            MISSING_VARIABLES=$(jq -r '.checks.variables.missing | length' "$LOG_FILE")

            echo "missing_labels=$MISSING_LABELS" >> $GITHUB_OUTPUT
            echo "missing_secrets=$MISSING_SECRETS" >> $GITHUB_OUTPUT
            echo "missing_variables=$MISSING_VARIABLES" >> $GITHUB_OUTPUT
          fi

      - name: Fail job if prerequisites missing
        if: steps.parse.outputs.status != 'pass' && steps.parse.outputs.status != 'error'
        run: |
          echo "❌ Preflight check failed: ${{ steps.parse.outputs.summary }}"
          echo "Missing labels: ${{ steps.parse.outputs.missing_labels }}"
          echo "Missing secrets: ${{ steps.parse.outputs.missing_secrets }}"
          echo "Missing variables: ${{ steps.parse.outputs.missing_variables }}"
          exit 1

      - name: Create issue on failure
        if: failure() && steps.parse.outputs.status == 'fail' && github.event_name != 'pull_request'
        run: |
          ISSUE_TITLE="[Preflight] AI prerequisites check failed"

          # Check if issue already exists
          EXISTING=$(gh issue list --repo "${{ github.repository }}" --state open --label "ai:triage" --search "$ISSUE_TITLE" --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "Issue already exists: #$EXISTING"
            gh issue comment "$EXISTING" --repo "${{ github.repository }}" --body "Status: ${{ steps.parse.outputs.summary }}&#10;Last check: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          else
            # Create new issue
            gh issue create \
              --repo "${{ github.repository }}" \
              --title "$ISSUE_TITLE" \
              --label "ai:triage,ai:blocked" \
              --body "## Preflight Check Failed&#10;&#10;**Status:** ${{ steps.parse.outputs.summary }}&#10;**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)&#10;**Repository:** ${{ github.repository }}&#10;&#10;### Missing Items&#10;- **Labels:** ${{ steps.parse.outputs.missing_labels }}&#10;- **Secrets:** ${{ steps.parse.outputs.missing_secrets }}&#10;- **Variables:** ${{ steps.parse.outputs.missing_variables }}&#10;&#10;### Action Required&#10;Please add the missing labels/secrets/variables before running AI automation workflows.&#10;&#10;---&#10;*Auto-generated by ai-prereqs-check workflow*"
          fi

      - name: Comment on PR on failure
        if: failure() && steps.parse.outputs.status == 'fail' && github.event_name == 'pull_request'
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" --repo "${{ github.repository }}" \
            --body "## ⚠️ Preflight Check Failed&#10;&#10;**Status:** ${{ steps.parse.outputs.summary }}&#10;&#10;### Missing Items&#10;- **Labels:** ${{ steps.parse.outputs.missing_labels }}&#10;- **Secrets:** ${{ steps.parse.outputs.missing_secrets }}&#10;- **Variables:** ${{ steps.parse.outputs.missing_variables }}&#10;&#10;Please ensure all prerequisites are configured before merging this PR."

      - name: Success message
        if: steps.parse.outputs.status == 'pass'
        run: |
          echo "✅ All AI prerequisites check passed"
      - name: Report legacy required status context (preflight)
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          JOB_STATUS: ${{ job.status }}
        run: |
          set -euo pipefail
          state="success"
          if [ "$JOB_STATUS" != "success" ]; then state="failure"; fi
          if command -v gh >/dev/null 2>&1; then
            gh api -X POST "repos/${{ github.repository }}/statuses/${{ github.sha }}" \
              -f state="$state" \
              -f context="preflight" \
              -f description="Legacy required status context for branch protection" \
              -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            curl -sS -X POST \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "Accept: application/vnd.github+json" \
              "${{ github.api_url }}/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
              -d "{\"state\":\"$state\",\"context\":\"preflight\",\"description\":\"Legacy required status context for branch protection\",\"target_url\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
          fi

  preflight:
    name: preflight
    runs-on: ubuntu-latest
    needs: [preflight-check]
    if: always()
    steps:
      - name: Propagate preflight-check result
        run: |
          echo "preflight-check result: ${{ needs.preflight-check.result }}"
          if [ "${{ needs.preflight-check.result }}" != "success" ]; then
            echo "preflight-check did not succeed" >&2
            exit 1
          fi

