# Publish Issues Scripts

This directory contains scripts for publishing issues from SSOT (Single Source of Truth) markdown files to GitHub.

## publish-issues.ps1

Publishes issues from `ops/issues/<project>/` directory to GitHub with update-in-place Task Links.

### Parameters

- `-RepoOwner` (required): GitHub repository owner (e.g., "anomalyco")
- `-RepoName` (required): GitHub repository name (e.g., "crm-lab-sandbox")
- `-IssuesDir` (required): Path to issues directory containing spec-*.md and task-*.md files
- `-DryRun` (optional): Run without making changes to GitHub
- `-TaskLinksWriteMode` (optional): "append" or "update" (default: "update")

### Usage

```powershell
# Normal run with update-in-place mode (default)
.\publish-issues.ps1 -RepoOwner "anomalyco" -RepoName "crm-lab-sandbox" -IssuesDir "./ops/issues/gcp-serverless-crm-poc"

# Dry run to see what would change
.\publish-issues.ps1 -RepoOwner "anomalyco" -RepoName "crm-lab-sandbox" -IssuesDir "./ops/issues/gcp-serverless-crm-poc" -DryRun

# Force append mode (old behavior)
.\publish-issues.ps1 -RepoOwner "anomalyco" -RepoName "crm-lab-sandbox" -IssuesDir "./ops/issues/gcp-serverless-crm-poc" -TaskLinksWriteMode append
```

### Features

1. **Update-in-place Task Links**: Automatically updates existing Task Links comments instead of creating duplicates
2. **Idempotent**: Running multiple times produces the same result
3. **Dry run support**: Preview changes without modifying GitHub
4. **Rollback capability**: `-TaskLinksWriteMode append` flag for emergency rollback
5. **Safety checks**: Validates comment content before updating
6. **Duplicate handling**: Updates the newest marker comment if multiple exist

### Task Links Comment Format

The auto-generated Task Links comment includes:
- Marker: `<!-- TASK_LINKS_AUTOGEN v1 -->`
- Header: "## Task Links"
- List of linked tasks: "- Task #10", "- Task #11", etc.
- Footer: "*Auto-generated by publish-issues.ps1*"

### SSOT File Format

Spec files (`spec-*.md`) must include:
```
**Spec Issue:** #9
```

Task files (`task-*.md`) are automatically detected and linked.

### Verification

To verify the update-in-place behavior:

```powershell
# Run once (creates comment)
.\publish-issues.ps1 -RepoOwner "owner" -RepoName "repo" -IssuesDir "./ops/issues/gcp-serverless-crm-poc"

# Run again (updates or skips, no duplicate)
.\publish-issues.ps1 -RepoOwner "owner" -RepoName "repo" -IssuesDir "./ops/issues/gcp-serverless-crm-poc"
```

Expected output:
- First run: "Task Links comment created."
- Second run (no changes): "Task Links comment already up-to-date (Comment ID: 123456). Skipping."
- Second run (with changes): "Task Links comment updated (Comment ID: 123456)."
