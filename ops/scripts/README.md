# Ops Scripts

This directory contains operational scripts for managing AI automation prerequisites and publishing issues.

## check-ai-prereqs.ps1

Preflight check script for AI automation prerequisites (labels, repo variables, and secret names).

### Parameters

- `-Repo` (required): GitHub repository in format "owner/repo" (e.g., "anomalyco/crm-lab-sandbox")
- `-ConfigPath` (optional): Path to JSON config file (default: `check-ai-prereqs.config.json`)
- `-JsonOnly` (optional): Only output JSON, skip human-readable summary

### Usage

```powershell
# Standard run with human-readable output and JSON report
.\check-ai-prereqs.ps1 -Repo "anomalyco/crm-lab-sandbox"

# JSON-only output (for automation)
.\check-ai-prereqs.ps1 -Repo "anomalyco/crm-lab-sandbox" -JsonOnly

# Custom configuration file
.\check-ai-prereqs.ps1 -Repo "anomalyco/crm-lab-sandbox" -ConfigPath "./custom-config.json"
```

### Features

1. **Label validation**: Checks if all required GitHub labels exist
2. **Secret validation**: Verifies required secret names exist (does not check values)
3. **Variable validation**: Verifies required repo variables exist
4. **Dual output**: Machine-readable JSON report + human-readable summary
5. **Non-zero exit code**: Returns error code when prerequisites are missing
6. **Configurable**: Prerequisites defined in `check-ai-prereqs.config.json`
7. **Permission-aware**: Gracefully handles API permission errors

### Configuration

Edit `check-ai-prereqs.config.json` to customize required prerequisites:

```json
{
  "labels": [
    "ai:ready",
    "ai:blocked",
    "ai:in-progress",
    "ai:triage",
    "ai:approved",
    "ai:risky-change",
    "ai:deps",
    "ai:pr-open"
  ],
  "secrets": [
    "ZAI_API_KEY",
    "ZHIPU_API_KEY"
  ],
  "variables": []
}
```

### Output

The script writes JSON output to `ops/logs/ai-prereqs-YYYYMMDD-HHmmss.json` with the following structure:

```json
{
  "timestamp": "2026-02-02T12:59:46.3880926Z",
  "repo": "owner/repo",
  "status": "pass|fail|error",
  "summary": "Human-readable summary",
  "checks": {
    "labels": {
      "required": ["..."],
      "existing": ["..."],
      "missing": ["..."],
      "status": "pass|fail"
    },
    "secrets": { ... },
    "variables": { ... }
  }
}
```

### Exit Codes

- `0`: All prerequisites found
- `1`: One or more prerequisites missing or API errors

### Verification

```powershell
# Run preflight check
pwsh -NoProfile -ExecutionPolicy Bypass -File .\ops\scripts\check-ai-prereqs.ps1 -Repo owner/repo

# Inspect JSON output
Get-Content .\ops\logs\ai-prereqs-*.json | ConvertFrom-Json | Format-List
```

---

## publish-issues.ps1

Publishes issues from SSOT (Single Source of Truth) markdown files to GitHub with update-in-place Task Links.

## publish-issues.ps1

Publishes issues from `ops/issues/<project>/` directory to GitHub with update-in-place Task Links.

### Parameters

- `-RepoOwner` (required): GitHub repository owner (e.g., "anomalyco")
- `-RepoName` (required): GitHub repository name (e.g., "crm-lab-sandbox")
- `-IssuesDir` (required): Path to issues directory containing spec-*.md and task-*.md files
- `-DryRun` (optional): Run without making changes to GitHub
- `-TaskLinksWriteMode` (optional): "append" or "update" (default: "update")

### Usage

```powershell
# Normal run with update-in-place mode (default)
.\publish-issues.ps1 -RepoOwner "anomalyco" -RepoName "crm-lab-sandbox" -IssuesDir "./ops/issues/gcp-serverless-crm-poc"

# Dry run to see what would change
.\publish-issues.ps1 -RepoOwner "anomalyco" -RepoName "crm-lab-sandbox" -IssuesDir "./ops/issues/gcp-serverless-crm-poc" -DryRun

# Force append mode (old behavior)
.\publish-issues.ps1 -RepoOwner "anomalyco" -RepoName "crm-lab-sandbox" -IssuesDir "./ops/issues/gcp-serverless-crm-poc" -TaskLinksWriteMode append
```

### Features

1. **Update-in-place Task Links**: Automatically updates existing Task Links comments instead of creating duplicates
2. **Idempotent**: Running multiple times produces the same result
3. **Dry run support**: Preview changes without modifying GitHub
4. **Rollback capability**: `-TaskLinksWriteMode append` flag for emergency rollback
5. **Safety checks**: Validates comment content before updating
6. **Duplicate handling**: Updates the newest marker comment if multiple exist

### Task Links Comment Format

The auto-generated Task Links comment includes:
- Marker: `<!-- TASK_LINKS_AUTOGEN v1 -->`
- Header: "## Task Links"
- List of linked tasks: "- Task #10", "- Task #11", etc.
- Footer: "*Auto-generated by publish-issues.ps1*"

### SSOT File Format

Spec files (`spec-*.md`) must include:
```
**Spec Issue:** #9
```

Task files (`task-*.md`) are automatically detected and linked.

### Verification

To verify the update-in-place behavior:

```powershell
# Run once (creates comment)
.\publish-issues.ps1 -RepoOwner "owner" -RepoName "repo" -IssuesDir "./ops/issues/gcp-serverless-crm-poc"

# Run again (updates or skips, no duplicate)
.\publish-issues.ps1 -RepoOwner "owner" -RepoName "repo" -IssuesDir "./ops/issues/gcp-serverless-crm-poc"
```

Expected output:
- First run: "Task Links comment created."
- Second run (no changes): "Task Links comment already up-to-date (Comment ID: 123456). Skipping."
- Second run (with changes): "Task Links comment updated (Comment ID: 123456)."
